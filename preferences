================================================================================
INFRASTRUCTURE LEBLAIS.NET - Documentation compl√®te
Repository GitHub: https://github.com/marecaillefrederic-lab/claude (Private)
Derni√®re mise √† jour: 02/11/2025
================================================================================

================================================================================
POUR TOUTES LES COMMANDES DANS LE TERMINAL, UTILISER L'EDITEUR VIM!!
================================================================================

================================================================================
Responsable moyens de paiement et fraude dans le e-commerce
********************************************************************************
Pratique de la musculation en salle 5 fois par semaine selon le mod√®le ppl + upper/lower
Pratique du jeune altern√© ADF
prise de ces compl√©ments alimentaires :
jours d'alimentation: prot√©ines whey + cr√©atine
√¢ge: 46 ans n√© le 26/03/1979
taille 1,81m
poids: 90kgs
Points d'attention dans votre cas :
Avec le je√ªne ADF + 5 s√©ances/semaine, vous √™tes d√©j√† dans une approche assez exigeante. √Ä 87 kg actuellement, vous √™tes dans une bonne zone, mais surveillez :

Vos performances en salle - Si votre force baisse significativement, c'est un signal d'alarme
Votre r√©cup√©ration - Le je√ªne ADF peut impacter la r√©cup√©ration musculaire
Votre composition corporelle - L'important n'est pas tant le poids que le ratio muscle/gras

Recommandations :

Stabilisez-vous entre 82-85 kg pour conserver votre masse musculaire
Si vous voulez vraiment descendre, ne passez pas sous 78 kg (seuil critique)
Surveillez votre taux de masse grasse (visez 12-15% minimum pour la sant√©)

√Ä 46 ans, pr√©server votre masse musculaire est crucial pour votre m√©tabolisme et votre sant√© √† long terme. Perdre 3 kg en 2 mois est un rythme raisonnable. Si vous continuez √† perdre, ralentissez le d√©ficit.

================================================================================

Infrastructure compl√®te de votre serveur
Informations syst√®me
Type : VM Debian 12 sur Proxmox (Freebox Delta)
RAM : 2 Go (actuellement ~680 Mo utilis√©s)
IP locale : 192.168.1.41
IP publique : 82.67.173.61
Domaine : leblais.net (DNS g√©r√© via OVH)
DMZ : Activ√©e sur la Freebox vers 192.168.1.41
Architecture : arm64

Services auto-h√©berg√©s accessibles

Portail d'accueil
URL : https://vault.leblais.net
Installation : /var/www/vault
Type : HTML statique avec cartes pour tous les services
Logs : /var/log/caddy/vault-access.log

Vaultwarden (gestionnaire de mots de passe)
URL : https://vaultwarden.leblais.net
Installation : /opt/vaultwarden (Docker)
Port interne : 8080
Base de donn√©es : SQLite dans /opt/vaultwarden/data
Container : vaultwarden
Image : vaultwarden/server:latest
ADMIN_TOKEN : Hash√© en Argon2 (s√©curis√©)
Configuration :
- SIGNUPS_ALLOWED: false (inscriptions d√©sactiv√©es)
- INVITATIONS_ALLOWED: true
- Logs : docker logs vaultwarden
Fail2ban actif : caddy-vaultwarden

Uptime Kuma (monitoring)
URL : https://uptime.leblais.net
Installation : /opt/uptime-kuma (Docker)
Port interne : 3001
Container : uptime-kuma
Image : louislam/uptime-kuma:1
Monitoring : Tous les services (intervalle 60s)
Notifications : Email, Telegram, etc. configurables
Logs : docker logs uptime-kuma
Fail2ban actif : caddy-uptime

Linkding (gestionnaire de bookmarks)
URL : https://bookmarks.leblais.net
Installation : /opt/linkding (Docker)
Port interne : 9092
Base de donn√©es : SQLite dans /opt/linkding/data
Container : linkding
Image : sissbruecker/linkding:latest
Compte admin : freebox
API Token : Disponible dans Settings ‚Üí Integrations
Bookmarklet configur√© pour ajout rapide
Fail2ban actif : caddy-bookmarks

Actual Budget (gestion finances personnelles)
URL : https://budget.leblais.net
Installation : /opt/actual-budget (Docker)
Port interne : 5006
Container : actual-budget
Image : actualbudget/actual-server:latest
Base de donn√©es : SQLite dans /opt/actual-budget/data
Configuration :
- TZ : Europe/Paris
- Sync automatique entre appareils
- PWA mobile disponible
- Import CSV bancaire support√©
Logs : docker logs actual-budget
Fail2ban actif : caddy-budget
Documentation : https://actualbudget.org/docs/
******MISE A JOUR*************
cd /opt/actual-budget

# T√©l√©charger la nouvelle image
docker-compose pull

# Recr√©er le conteneur avec la nouvelle version
docker-compose up -d

# V√©rifier que tout fonctionne
docker logs actual-budget
******************************

Authelia (authentification SSO)
URL : https://auth.leblais.net
Installation : /opt/authelia
Port interne : 9091
Configuration : /etc/authelia/configuration.yml
Base utilisateurs : /etc/authelia/users_database.yml
Base de donn√©es : SQLite dans /var/lib/authelia
Binaire : /opt/authelia/authelia
Service : authelia.service
Logs : journalctl -u authelia -f
Prot√®ge : Services sensibles via Caddy

Terminal Web (ttyd)
URL : https://terminal.leblais.net
Installation : /usr/local/bin/ttyd
Port interne : 7681
Service : ttyd.service
Authentification : Via Authelia
Commande : bash en lecture seule
Logs : journalctl -u ttyd -f
Fail2ban actif : caddy-terminal

Workout Tracker (suivi musculation PPL)
URL : https://workout.leblais.net
Installation : /var/www/workout
Type : HTML statique (localStorage)
Logs : /var/log/caddy/workout-access.log
Architecture : Application HTML statique avec synchronisation API PHP
Fichiers importants :
- index.html : Application frontend (HTML/JS avec localStorage)
- api.php : Backend de synchronisation
- data/workout-data.json : Donn√©es synchronis√©es (20Ko)
- data/*.backup.* : Backups automatiques (5 derniers conserv√©s)
API de synchronisation :
- Endpoint : https://workout.leblais.net/api.php
- API Key : freddebian79claudius
- Authentification : Header "Authorization: Bearer freddebian79claudius"
- Actions : GET ?action=load (charger) | POST ?action=save (sauvegarder)
- Backups auto : Cr√©√©s √† chaque sauvegarde (5 derniers gard√©s)
Configuration Caddy requise :
N√©cessite `php_fastcgi unix//run/php/php8.2-fpm.sock` pour ex√©cuter api.php
Sans cette ligne, l'API ne fonctionne pas et l'app affiche "hors ligne"
Fonctionnement :
- Donn√©es stock√©es localement (localStorage navigateur) + synchro serveur
- Synchronisation automatique entre PC/tablette/t√©l√©phone via API
- Programme PPL (Push/Pull/Legs) + Upper/Lower
- Stats : volume hebdomadaire, progression, records, analyse
D√©pendances :
- PHP 8.2-FPM (service php8.2-fpm)
- Permissions : www-data:www-data sur /var/www/workout/data/

Interface Freebox
URL : https://freebox.leblais.net
Port interne : 80 (Freebox locale sur 192.168.1.254)
Reverse proxy via Caddy
Certificat SSL Let's Encrypt (DNS challenge OVH)
Fail2ban actif : caddy-freebox

Cockpit (administration syst√®me)
URL : https://cockpit.leblais.net
Port interne : 9090
Reverse proxy via Caddy
Fail2ban actif : caddy-cockpit
Config requise dans /etc/cockpit/cockpit.conf :
[WebService]
Origins = https://cockpit.leblais.net wss://cockpit.leblais.net
ProtocolHeader = X-Forwarded-Proto
ForwardedForHeader = X-Forwarded-For
AllowUnencrypted = true

FreshRSS (agr√©gateur RSS)
URL : https://rss.leblais.net
Installation : /var/www/freshrss
Base de donn√©es : SQLite
PHP-FPM via Caddy
Fail2ban actif : caddy-freshrss

rtorrent + ruTorrent + ProtonVPN (namespace isol√©)
URL : https://torrent.leblais.net
Architecture :
- rtorrent 0.9.8 tourne dans un namespace "vpn" isol√©
- Seul rtorrent passe par ProtonVPN (OpenVPN) - IP polonaise 149.102.244.x
- Le reste de la VM (workout, cockpit, wg0, etc.) reste sur le r√©seau normal
- Interface web : https://torrent.leblais.net (auth: freebox/[mdp])
Chemins importants :
- Config rtorrent : `/root/.rtorrent.rc` (car rtorrent tourne en root dans le namespace)
- Config ruTorrent : `/var/www/ruTorrent/conf/config.php`
- T√©l√©chargements en cours : `/mnt/WD_Freebox/T√©l√©chargements/incomplete/`
- T√©l√©chargements termin√©s : `/mnt/WD_Freebox/T√©l√©chargements/complete/`
- Watch folder : `/home/freebox/rtorrent/.watch/`
- Session rtorrent : `/home/freebox/rtorrent/session/`
- Config OpenVPN : `/etc/openvpn/protonvpn/pl-free-13.protonvpn.udp.ovpn`
- Auth OpenVPN : `/etc/openvpn/protonvpn/auth.txt`
- Script d√©marrage VPN : `/usr/local/bin/protonvpn-namespace.sh`
- Script setup namespace : `/usr/local/bin/setup-vpn-namespace.sh`
- Logs OpenVPN : `/var/log/openvpn-vpn-namespace.log`
Services systemd :
- `setup-vpn-namespace.service` : Cr√©√© le namespace "vpn" au d√©marrage
- `protonvpn-namespace.service` : Lance OpenVPN dans le namespace
- `rtorrent.service` : Lance rtorrent dans le namespace (d√©pend du VPN)
Configuration r√©seau :
- Namespace : `vpn`
- Interface VPN dans namespace : `tun0` (10.96.0.x)
- Interfaces virtuelles : `veth0` (h√¥te: 10.200.200.1) ‚Üî `veth1` (namespace: 10.200.200.2)
- SCGI : rtorrent √©coute sur `0.0.0.0:5000` dans le namespace
- ruTorrent se connecte √† `10.200.200.2:5000`
- Timeout SCGI : 10 secondes (configur√© dans config.php)
- Port BitTorrent : 50000 (UDP/TCP)
- Port DHT : 6881
Commandes utiles :
```bash
# Red√©marrer les services
sudo systemctl restart protonvpn-namespace
sudo systemctl restart rtorrent

# V√©rifier l'IP du VPN
sudo ip netns exec vpn curl ifconfig.me  # Doit √™tre 149.102.244.x

# Voir les connexions rtorrent
sudo ip netns exec vpn netstat -tnp | grep rtorrent

# Logs
sudo tail -f /var/log/openvpn-vpn-namespace.log
journalctl -u rtorrent -f

# Acc√©der √† l'interface CLI rtorrent
sudo ip netns exec vpn screen -r rtorrent  # Ctrl+A puis D pour d√©tacher

# Lister les namespaces
sudo ip netns list
```
Recr√©er manuellement le namespace (si probl√®me apr√®s reboot) :
```bash
sudo ip netns add vpn
sudo ip link add veth0 type veth peer name veth1
sudo ip link set veth1 netns vpn
sudo ip addr add 10.200.200.1/24 dev veth0
sudo ip link set veth0 up
sudo ip netns exec vpn ip addr add 10.200.200.2/24 dev veth1
sudo ip netns exec vpn ip link set veth1 up
sudo ip netns exec vpn ip link set lo up
sudo systemctl restart protonvpn-namespace
sudo systemctl restart rtorrent
```
Plugins ruTorrent d√©sactiv√©s :
Plusieurs plugins n√©cessitant un acc√®s direct au filesystem sont d√©sactiv√©s (.disabled) car rtorrent est dans un namespace isol√©. Les fonctions essentielles (ajout/suppression/stats) fonctionnent parfaitement.
S√©curit√© :
- Kill switch automatique : si ProtonVPN se d√©connecte, rtorrent s'arr√™te
- IP publique Free jamais expos√©e sur les trackers torrents
- Isolation totale du trafic torrent dans le namespace
Fail2ban actif : caddy-torrent

Dashboard Fail2ban
URL : https://fail2ban.leblais.net
Installation : /var/www/fail2ban-stats
Type : HTML g√©n√©r√© dynamiquement par script Python
Script : /var/www/fail2ban-stats/generate_stats.py
Donn√©es : /var/www/fail2ban-stats/data/stats.json
Mise √† jour : Auto toutes les heures via cron
Fonctionnalit√©s :
- Stats globales (jails actifs, IPs bannies, tentatives)
- Graphiques : Top pays, bans par jour/heure, stats par jail
- Tableau des 20 IPs les plus bannies avec g√©olocalisation
- Cartes color√©es par jail avec ic√¥nes
- Badge META dor√© pour fail2ban-stats (protection auto)
Design : Cartes modernes avec bordures color√©es selon activit√©
Auto-protection : fail2ban-stats jail prot√®ge le dashboard lui-m√™me
Fail2ban actif : fail2ban-stats

WireGuard VPN
Port : 51820/UDP
R√©seau VPN : 10.8.0.0/24
IP serveur VPN : 10.8.0.1
IP client mobile : 10.8.0.2
Configuration : /etc/wireguard/wg0.conf
Split tunneling configur√© : 192.168.1.0/24 + 10.8.0.0/24
Serveur WireGuard
Interface : wg0
Cl√©s : /etc/wireguard/server_*.key
Client configur√© : 1 (mobile Android avec app WireGuard)
DNS fourni aux clients : 10.8.0.1 (Pi-hole)
AllowedIPs client : 192.168.1.0/24, 10.8.0.0/24 (split tunneling)

Pi-hole (blocage de publicit√©s)
URL : https://pihole.leblais.net/admin
Installation : /etc/pihole
Port web : 8081
Base de donn√©es : SQLite (/etc/pihole/gravity.db, pihole-FTL.db)
Service : pihole-FTL.service
Serveur web : CivetWeb (int√©gr√© dans pihole-FTL)
Logs : /var/log/pihole/
Configuration : /etc/pihole/pihole.toml
Commandes utiles :
- pihole status
- pihole -g (update gravity)
- pihole setpassword
- pihole restartdns
Fail2ban actif : caddy-pihole
*********************************
MISE A JOUR
********************************
# 1. V√©rifier s'il y a des mises √† jour
pihole -v

# 2. Si des mises √† jour sont disponibles
sudo pihole -up

# 3. V√©rifier que tout fonctionne
pihole status
curl -I http://localhost:8081/admin/

Infrastructure de base

Reverse proxy : Caddy
Configuration : /etc/caddy/Caddyfile
Logs : /var/log/caddy/
Certificats SSL automatiques via DNS challenge OVH
Credentials OVH API configur√©s dans /etc/caddy/caddy.env
Variables d'environnement :
- OVH_APPLICATION_KEY
- OVH_APPLICATION_SECRET
- OVH_CONSUMER_KEY

Pare-feu : UFW
Ports autoris√©s : 22 (SSH custom port 24589), 80, 443, 51820/udp, 3000, 9090
R√®gles sp√©cifiques pour wg0

Protection : Fail2ban
Configuration : /etc/fail2ban/jail.local
Jails actives (12 jails) :
- sshd (port 24589)
- caddy-cockpit
- caddy-freebox
- caddy-freshrss
- caddy-terminal
- caddy-torrent
- caddy-vaultwarden
- caddy-uptime
- caddy-bookmarks
- caddy-pihole
- caddy-budget
- fail2ban-stats (META - se prot√®ge lui-m√™me)
Filtres personnalis√©s : /etc/fail2ban/filter.d/

SSH
Port custom : 24589 (non standard)
Redirection Freebox : WAN 24589 ‚Üí LAN 22

Docker
Installation : docker.io + docker-compose
Containers actifs :
- vaultwarden
- uptime-kuma
- linkding
- actual-budget

Backups automatiques

Script de backup complet
Emplacement : /usr/local/bin/backup-vm.sh
Ex√©cution : Cron quotidien √† 3h du matin
Logs : /var/log/backup-vm.log
Taille backup : ~66-107MB compress√©

Services sauvegard√©s :
- Configurations syst√®me : Caddy, Fail2ban, WireGuard, UFW, SSH, fstab
- Authelia : Config + base SQLite
- Cockpit : Configuration
- Docker : Configurations
- ProtonVPN : Config OpenVPN
- Services systemd : Tous les services custom
- Scripts custom : Tout /usr/local/bin
- rtorrent : Config + session
- ruTorrent : Configuration
- Sites web : Tous les sites /var/www
- Pi-hole : Configuration + bases SQLite
- Vaultwarden : Base de donn√©es SQLite
- Uptime Kuma : Base de donn√©es + configuration
- Linkding : Base de donn√©es + bookmarks
- Actual Budget : Base de donn√©es + configuration
- Crontabs : User + root
- Credentials : SMB, OVH API, rclone (configs chiffrement)
- Listes : Paquets, services, r√®gles UFW
- Infos syst√®me : Disques, RAM, r√©seau

Stockage backups :
- Local : /mnt/WD_Freebox/backups/vm-debian (30 derniers conserv√©s)
- Google Drive : gdrive-crypt: chiffr√© E2EE (30 derniers conserv√©s)

rclone + Google Drive + Chiffrement E2EE
Installation : rclone version 1.60.1
Configurations :
- /root/.config/rclone/rclone.conf (utilis√©e par le script backup)
- /home/freebox/.config/rclone/rclone.conf (config originale)
Remotes configur√©s :
- gdrive : Google Drive (OAuth2)
- gdrive-crypt : Chiffrement E2EE sur gdrive:Backups/VM-Debian/
Chiffrement : 
- Algorithme : AES-256 (NaCl SecretBox)
- Noms de fichiers : Chiffr√©s (standard)
- Noms de dossiers : Chiffr√©s
- Contenu : Chiffr√©
- Cl√©s : Stock√©es dans rclone.conf (sauvegard√©es dans les backups)
Utilisation : Upload automatique chiffr√© des backups quotidiens
Note CRITIQUE : Sans les mots de passe rclone (stock√©s dans Vaultwarden), impossible de d√©chiffrer les backups

Proc√©dure de restauration
# Lister les backups
sudo rclone ls gdrive-crypt:

# T√©l√©charger un backup
sudo rclone copy gdrive-crypt:backup_vm_YYYYMMDD_HHMMSS.tar.gz /tmp/

# Restaurer d'abord la config rclone (si n√©cessaire)
cd /tmp
sudo tar -xzf backup_vm_YYYYMMDD_HHMMSS.tar.gz backup_vm_YYYYMMDD_HHMMSS/root/.config/rclone/
sudo cp -r backup_vm_YYYYMMDD_HHMMSS/root/.config/rclone /root/.config/

# Extraire tout
sudo tar -xzf backup_vm_YYYYMMDD_HHMMSS.tar.gz

Acc√®s et s√©curit√©

Redirection de ports Freebox
SSH : 24589 ‚Üí 192.168.1.41:22
DMZ : Tous les autres ports ‚Üí 192.168.1.41

Certificats SSL
Type : Let's Encrypt wildcard
M√©thode : DNS-01 challenge via OVH
Renouvellement : Automatique par Caddy

DNS OVH
Sous-domaines configur√©s (tous ‚Üí 82.67.173.61) :
- vault.leblais.net
- vaultwarden.leblais.net
- uptime.leblais.net
- bookmarks.leblais.net
- budget.leblais.net
- auth.leblais.net
- terminal.leblais.net
- workout.leblais.net
- freebox.leblais.net
- cockpit.leblais.net
- rss.leblais.net
- torrent.leblais.net
- fail2ban.leblais.net
- pihole.leblais.net

Limitations connues
RAM limit√©e √† 2 Go (impossible d'installer des services lourds comme Bookwyrm, Nextcloud)
Pas de swap configur√©
Applications l√©g√®res privil√©gi√©es

Proc√©dures r√©utilisables √©tablies

Ajout d'un nouveau service via Caddy
1. Cr√©er sous-domaine DNS chez OVH
2. Ajouter bloc dans Caddyfile avec logs et TLS DNS challenge
3. Cr√©er filtre fail2ban si n√©cessaire
4. Red√©marrer Caddy

Fail2ban pour service Caddy
1. Activer logs Caddy pour le service
2. Cr√©er filtre dans /etc/fail2ban/filter.d/
3. Ajouter jail dans jail.local
4. Tester avec fail2ban-regex
5. Red√©marrer fail2ban

Ajout d'un site statique via Caddy
1. Cr√©er le r√©pertoire et permissions
   sudo mkdir -p /var/www/nom_service
   sudo chown -R $USER:$USER /var/www/nom_service
2. Cr√©er sous-domaine DNS chez OVH (A record vers 82.67.173.61)
3. Pr√©parer les logs Caddy
   sudo touch /var/log/caddy/nom_service-access.log
   sudo chown caddy:caddy /var/log/caddy/nom_service-access.log
   sudo chmod 644 /var/log/caddy/nom_service-access.log
4. Ajouter bloc dans Caddyfile avec logs et TLS DNS challenge
   Exemple de bloc :
   nom_service.leblais.net {
       root * /var/www/nom_service
       file_server
       encode gzip
       
       log {
           output file /var/log/caddy/nom_service-access.log
           format json
       }
       
       tls {
           dns ovh {
               endpoint ovh-eu
               application_key {env.OVH_APPLICATION_KEY}
               application_secret {env.OVH_APPLICATION_SECRET}
               consumer_key {env.OVH_CONSUMER_KEY}
           }
       }
   }
5. Valider : sudo caddy validate --config /etc/caddy/Caddyfile
6. Appliquer : sudo systemctl restart caddy (restart, pas reload si nouveaux logs)
7. V√©rifier : sudo journalctl -u caddy -f
8. Cr√©er filtre fail2ban si n√©cessaire (pour services avec authentification)

Ajout d'un service Docker
1. Cr√©er r√©pertoire : sudo mkdir -p /opt/nom_service
2. Cr√©er docker-compose.yml
3. Configurer les ports (127.0.0.1:PORT:PORT_INTERNE)
4. Cr√©er sous-domaine DNS chez OVH
5. Ajouter reverse_proxy dans Caddyfile
6. D√©marrer : docker-compose up -d
7. Ajouter √† backup-vm.sh
8. Ajouter √† Uptime Kuma pour monitoring

Editeur de texte en console par d√©faut : VIM
Remplacer nano par vim dans les instructions

Services en attente d'installation
- Gotify : Notifications push (si besoin de centraliser toutes les alertes, sinon Uptime Kuma suffit)

Notes importantes
- Tous les services utilisent HTTPS via Caddy avec Let's Encrypt
- Tous les services web sont prot√©g√©s par Fail2ban
- Backups quotidiens automatiques local + cloud (chiffr√©s E2EE)
- Monitoring 24/7 via Uptime Kuma
- RAM bien g√©r√©e : ~680MB/2GB utilis√©s
- 12 jails Fail2ban actives
- Dashboard fail2ban avec design moderne et cartes color√©es
- Chiffrement E2EE des backups : m√™me Google ne peut pas lire les donn√©es

Filebrowser (explorateur de fichiers)
URL : https://files.leblais.net
Installation : /opt/filebrowser (binaire)
Port interne : 8083
Configuration : /var/lib/filebrowser/filebrowser.json
Base de donn√©es : SQLite dans /var/lib/filebrowser/filebrowser.db
Binaire : /opt/filebrowser/filebrowser
Service : filebrowser.service
Logs : journalctl -u filebrowser -f
Prot√©g√© par : Authelia (one_factor)
Racine : /mnt/WD_Freebox/T√©l√©chargements
Utilisateurs : admin (avec permissions admin)
Fonctionnalit√©s :
- Navigation dans les fichiers t√©l√©charg√©s
- Pr√©visualisation m√©dias (vid√©os, images, PDF)
- T√©l√©chargement de fichiers
- Recherche
- Interface responsive (mobile-friendly)
Fail2ban actif : caddy-files

# Nextcloud - Cloud personnel familial

## Installation
- **Version** : Nextcloud 32.0.1.2
- **Date d'installation** : 13 novembre 2025
- **Serveur** : VM Freebox Delta (ARM64 / aarch64)
- **RAM allou√©e** : ~400 MB (PostgreSQL + PHP-FPM)
- **Stockage** : SMB Freebox (875 GB disponibles sur 917 GB)

## URLs et acc√®s
- **URL** : https://cloud.leblais.net
- **Utilisateur admin** : frederic
- **Note s√©curit√©** : A+ (scan https://scan.nextcloud.com)

## Architecture technique
- **Stack** :
  - Base de donn√©es : PostgreSQL 15
  - Serveur web : Caddy 2.x (reverse proxy + TLS automatique)
  - PHP : 8.2-FPM (optimis√© pour 2 GB RAM)
  - Cache : APCu (memcache local)

- **Stockage** :
  - Application : `/var/www/nextcloud`
  - Donn√©es : `/mnt/WD_Freebox/nextcloud-data` (partage SMB)
  - Montage : CIFS avec credentials

## Configuration sp√©cifique ARM/2GB RAM
- **PHP-FPM** :
  - pm.max_children = 10 (limite RAM)
  - memory_limit = 256M
  - upload_max_filesize = 512M

- **PostgreSQL** :
  - shared_buffers = 128MB
  - effective_cache_size = 512MB
  - max_connections = 20

## Applications install√©es
- ‚úÖ Calendar (agenda partag√© famille)
- ‚úÖ Contacts (carnet d'adresses synchronis√©)
- ‚úÖ Mail (client email int√©gr√©)
- ‚úÖ Notes (prise de notes)
- ‚úÖ Talk (messagerie/visio famille)
- ‚ùå Nextcloud Office (incompatible ARM - CODE impossible)
- ‚ùå OnlyOffice (trop gourmand en RAM - d√©sinstall√©)

## Synchronisation mobile (Android)
- **App** : DAVx5
- **Protocoles** :
  - CardDAV : Contacts bidirectionnel
  - CalDAV : Calendrier bidirectionnel
- **Apps compatibles** : Fossify Phone, Textra SMS, Simple Contacts
- **Google d√©sactiv√©** : Contacts et Agenda migr√©s vers Nextcloud

## Migration Google Drive
- **M√©thode** : Google Takeout (export 350 GB)
- **Import** : Via client desktop Nextcloud
- **R√©sultat** : Ind√©pendance totale de Google Drive

## S√©curit√©
- **TLS** : Let's Encrypt via Caddy (DNS OVH)
- **Fail2ban** : Protection brute-force (jail caddy-nextcloud)
- **Backup** : Automatique quotidien (config + PostgreSQL)
- **Headers** : HSTS, X-Frame-Options, CSP configur√©s

## Maintenance et monitoring
- **Cron** : Background jobs toutes les 5 minutes
- **Backup** : Script `/usr/local/bin/backup-vm.sh`
- **Monitoring** : Uptime Kuma (https://uptime.leblais.net)
- **Logs** : `/mnt/WD_Freebox/nextcloud-data/nextcloud.log`

## Commandes utiles
```bash
# Logs en temps r√©el
sudo -u www-data php /var/www/nextcloud/occ log:watch

# Maintenance mode
sudo -u www-data php /var/www/nextcloud/occ maintenance:mode --on/off

# Mettre √† jour Nextcloud
sudo -u www-data php /var/www/nextcloud/occ upgrade

# V√©rifier config
sudo -u www-data php /var/www/nextcloud/occ config:list system

# Scan fichiers
sudo -u www-data php /var/www/nextcloud/occ files:scan --all

# Espace disque
df -h /mnt/WD_Freebox
du -sh /mnt/WD_Freebox/nextcloud-data
```

## Performances et limitations
- **Upload/download** : Acceptable pour usage familial (3 personnes)
- **Latence SMB** : L√©g√®re sur pr√©visualisation photos (~1-2s)
- **RAM disponible** : ~300-400 MB apr√®s Nextcloud (suffisant)
- **√âdition documents** : En local puis sync (pas d'√©diteur en ligne sur ARM)

## Usage familial
- **Utilisateurs** : 3 comptes (frederic + 2 autres)
- **Quotas** : 100 GB par personne (personnalisable)
- **Partage** : Liens prot√©g√©s par mot de passe + expiration
- **Collaboration** : Partage de dossiers, commentaires, notifications

## Int√©gration avec autres services
- **Portail** : Visible sur https://vault.leblais.net
- **Backup** : Int√©gr√© dans backup quotidien VM
- **Vaultwarden** : Partage notes/fichiers sensibles compl√©mentaire

## Points d'attention
- ‚ö†Ô∏è OnlyOffice/CODE incompatibles ARM ‚Üí √âdition documents en local
- ‚ö†Ô∏è Performances SMB correctes mais pas optimales (vs. disque local)
- ‚ö†Ô∏è RAM limit√©e (2 GB) ‚Üí Pas de services gourmands suppl√©mentaires
- ‚úÖ Solution stable et l√©g√®re adapt√©e √† l'usage familial

## Prochaines √©tapes potentielles
- [ ] Brancher disque USB 1TB pour backup local donn√©es Nextcloud
- [ ] Configurer e-mail sortant (SMTP) pour notifications
- [ ] Activer chiffrement bout-en-bout dans Talk
- [ ] Explorer apps : Photos (albums), Tasks, Deck (kanban)

## Ressources
- Documentation : https://docs.nextcloud.com
- Forum : https://help.nextcloud.com
- Apps : https://apps.nextcloud.com

## Optimisations Nextcloud 2GB RAM

### Configuration finale
- **RAM VM** : 2048 MB (Freebox Server Ultra)
- **Fichiers** : 41,665 (296 GB)
- **RAM disponible** : 320-880 MB

### Modifications cl√©s

**PHP-FPM** (`/etc/php/8.2/fpm/pool.d/www.conf`) :
```ini
pm.max_children = 5
pm.start_servers = 1
pm.min_spare_servers = 1
pm.max_spare_servers = 2
pm.max_requests = 500
```

**PostgreSQL** (`/etc/postgresql/15/main/postgresql.conf`) :
```ini
shared_buffers = 64MB
effective_cache_size = 256MB
work_mem = 2MB
maintenance_work_mem = 16MB
max_connections = 15
```

**Redis** (`/etc/redis/redis.conf`) :
```ini
maxmemory 64mb
```

**Nextcloud** :
```bash
enable_previews = false
connectivity_check_domains = []
```

**Apps d√©sactiv√©es** :
activity, dashboard, weather_status, circles, user_status, etc.

### R√©sultats
- Navigation : Fluide (300 fichiers/dossier)
- Stabilit√© : Excellente
- RAM : 320-880 MB disponibles
```

## Prochaines √©tapes (quand tu veux)

### ‚úÖ Termin√©
- Installation Nextcloud
- Migration Google Drive (290 GB)
- Migration Contacts/Calendrier
- Optimisation RAM 2 GB
- Synchronisation mobile DAVx5

### üîú √Ä faire plus tard

**Quand DD externe 1To arrive :**
1. Brancher DD sur Freebox
2. Monter sur VM
3. Modifier script backup
4. Supprimer backup Google Drive
5. Tester backup/restore

**Optionnel :**
- Cr√©er 2 autres comptes famille
- Configurer notifications email
- Explorer Talk pour visio famille
- Installer clients desktop pour tous

## Statistiques finales du projet
```
Dur√©e totale projet : ~3 jours
  - Installation : 2h
  - Migration donn√©es : 12h (nuit)
  - Scan fichiers : 45 min
  - Optimisations : 1h
  - Debug/tests : 2h

Donn√©es migr√©es : 290 GB (41k fichiers)
Co√ªt mensuel : 0‚Ç¨
Ind√©pendance : 100% ‚úÖ

Google services remplac√©s :
  ‚úÖ Drive ‚Üí Nextcloud
  ‚úÖ Contacts ‚Üí Nextcloud + DAVx5
  ‚úÖ Calendar ‚Üí Nextcloud + DAVx5
  (Gmail : conserv√© pour l'instant)
