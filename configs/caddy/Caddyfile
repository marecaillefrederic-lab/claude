{
    email frederic@leblais.net
}

# Nextcloud
cloud.leblais.net {
    log {
        output file /var/log/caddy/cloud-access.log
        format json
    }
    
    tls {
        dns ovh {
            endpoint {env.OVH_ENDPOINT}
            application_key {env.OVH_APPLICATION_KEY}
            application_secret {env.OVH_APPLICATION_SECRET}
            consumer_key {env.OVH_CONSUMER_KEY}
        }
    }
    
    root * /var/www/nextcloud
    file_server
    
    php_fastcgi unix//run/php/php8.4-fpm.sock {
        env front_controller_active true
    }
    
    header {
        Strict-Transport-Security "max-age=31536000;"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Robots-Tag "noindex, nofollow"
        X-Download-Options "noopen"
        X-Permitted-Cross-Domain-Policies "none"
        Referrer-Policy "no-referrer"
    }
    
    @forbidden {
        path /.htaccess
        path /data/*
        path /config/*
        path /db_structure
        path /.xml
        path /README
        path /3rdparty/*
        path /lib/*
        path /templates/*
        path /occ
        path /console.php
    }
    
    respond @forbidden 404
    
    redir /.well-known/carddav /remote.php/dav 301
    redir /.well-known/caldav /remote.php/dav 301
    redir /.well-known/webfinger /index.php/.well-known/webfinger 301
    redir /.well-known/nodeinfo /index.php/.well-known/nodeinfo 301
}

vaultwarden.leblais.net {
    log {
        output file /var/log/caddy/vaultwarden-access.log
        format json
    }
    
    tls {
        dns ovh {
            endpoint {env.OVH_ENDPOINT}
            application_key {env.OVH_APPLICATION_KEY}
            application_secret {env.OVH_APPLICATION_SECRET}
            consumer_key {env.OVH_CONSUMER_KEY}
        }
    }
    
    reverse_proxy localhost:8080
}

uptime.leblais.net {
    log {
        output file /var/log/caddy/uptime-access.log
        format json
    }
    
    reverse_proxy localhost:3001
}

bookmarks.leblais.net {
    log {
        output file /var/log/caddy/bookmarks-access.log
        format json
    }
    
    reverse_proxy localhost:9092
}

workout.leblais.net {
    log {
        output file /var/log/caddy/workout-access.log
        format json
    }
    
    forward_auth localhost:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
    }
    
    root * /var/www/workout
    file_server
    php_fastcgi unix//run/php/php8.4-fpm.sock
    
    @data {
        path /data/*
    }
    handle @data {
        file_server
    }
}

pihole.leblais.net {
    log {
        output file /var/log/caddy/pihole-access.log
        format json
    }
    
    reverse_proxy localhost:8053
}

budget.leblais.net {
    log {
        output file /var/log/caddy/budget-access.log
        format json
    }
    
    forward_auth localhost:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
    }
    
    root * /var/www/budget
    file_server
    php_fastcgi unix//run/php/php8.4-fpm.sock
    
    @data {
        path /data/*
    }
    handle @data {
        file_server
    }
}

rss.leblais.net {
    log {
        output file /var/log/caddy/rss-access.log
        format json
    }
    
    root * /var/www/freshrss/p
    file_server
    php_fastcgi unix//run/php/php8.4-fpm.sock
    
    @static {
        path /themes/* /scripts/* /images/*
    }
    handle @static {
        file_server
    }
    
    try_files {path} {path}/ /index.php
}

files.leblais.net {
    log {
        output file /var/log/caddy/files-access.log
        format json
    }
    
    reverse_proxy localhost:8081
}

torrent.leblais.net {
    log {
        output file /var/log/caddy/torrent-access.log
        format json
    }
    
    reverse_proxy localhost:8082
}

vault.leblais.net {
    root * /var/www/vault
    file_server
}

fail2ban.leblais.net {
    log {
        output file /var/log/caddy/fail2ban-access.log
        format json
    }
    
    root * /var/www/fail2ban-stats
    file_server
}

auth.leblais.net {
    reverse_proxy localhost:9091
}

office.leblais.net {
    reverse_proxy localhost:8088
}

terminal.leblais.net {
    log {
        output file /var/log/caddy/terminal-access.log
        format json
    }
    
    forward_auth localhost:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
    }
    
    reverse_proxy localhost:7681
}
